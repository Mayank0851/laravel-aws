name: Deploy Laravel App

on:
  push:
    branches:
      - main  

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout code
      - name: Checkout code
        uses: actions/checkout@v3

      # Step 2: Set up SSH
      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      # Step 3: Add GitHub to known_hosts
      - name: Add GitHub to known_hosts
        run: ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts

      # Step 4: Deploy to EC2
      - name: Deploy to EC2
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@3.111.198.113 << 'EOF'
            set -e

            echo "Navigating to application directory"
            cd /var/www/laravel-aws

            echo "Pulling latest changes from GitHub"
            git pull https://<username>:${{ secrets.GITHUB_TOKEN }}@github.com/Mayank0851/laravel-aws.git | tee git_pull.log

            echo "Installing PHP dependencies"
            composer install --no-interaction --prefer-dist --optimize-autoloader | tee composer_install.log

            echo "Setting up Laravel environment"
            cp .env.example .env
            php artisan key:generate

            echo "Installing Node.js"
            curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
            sudo apt-get install -y nodejs

            echo "Installing Node.js packages and building assets"
            npm install | tee npm_install.log
            npm run build | tee npm_build.log

            echo "Running database migrations"
            php artisan migrate --force | tee migrate.log

            echo "Optimizing application"
            php artisan optimize | tee optimize.log

            echo "Setting permissions"
            sudo chown -R www-data:www-data storage bootstrap/cache
            sudo chmod -R 775 storage bootstrap/cache

            echo "Restarting Nginx"
            sudo service nginx restart || echo "Nginx restart failed"

            echo "Testing application status"
            curl -f http://localhost/status || echo "Application is not responding"

          EOF

        
