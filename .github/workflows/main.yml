name: Deploy Laravel App

on:
    push:
        branches:
            - main  # Adjust this if you're using a different branch for deployment

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            # Step 1: Checkout code
            - name: Checkout code
              uses: actions/checkout@v3

            # Step 2: Set up SSH
            - name: Set up SSH
              uses: webfactory/ssh-agent@v0.7.0
              with:
                  ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

            # Step 3: Test SSH connection (Optional)
            - name: Test SSH connection
              run: |
                  ssh -o StrictHostKeyChecking=no ubuntu@65.2.188.137 'echo "SSH connection successful"'

            # Step 4: Deploy to EC2
            - name: Deploy to EC2
              run: |
                  ssh -o StrictHostKeyChecking=no ubuntu@65.2.188.137 << 'EOF'
                    set -e  # Exit immediately if a command exits with a non-zero status
                    echo "Navigating to application directory"
                    cd /var/www/laravel-aws
                    
                    echo "Pulling latest changes from your GitHub repository"
                    git pull git@github.com:Mayank0851/laravel-aws.git
                    echo "Git pull completed"
                    
                    echo "Installing PHP dependencies"
                    composer install --no-interaction --prefer-dist --optimize-autoloader
                    
                    echo "Installing Node.js packages"
                    npm install
                    echo "Building assets"
                    npm run build
                    
                    echo "Running database migrations"
                    php artisan migrate --force
                    
                    echo "Optimizing application"
                    php artisan optimize
                    
                    echo "Reloading Nginx"
                    sudo systemctl daemon-reload
                    sudo service nginx restart
                    echo "Deployment complete!"
                  EOF

            # Optional: Notify Deployment Status
            - name: Notify Deployment Status
              run: |
                  echo "Deployment completed successfully!" | mail -s "Deployment Status" vishwakarmamayank451@gmail.com


